# Code Standards

**Source of Truth**: Both (this file for detailed standards, CLAUDE.md for overview)
**Last Updated**: 2026-01-17

## Core Principles

**Evidence-based**: Prove impact, never speculate.
**Autonomous**: Choose implementation approaches freely within guardrails.
**Context-efficient**: Preserve main context window.

## Hard Constraints

- No Claude Code branding or signatures in output
- No speculation language ("may", "could", "seems", "probably")
- No claiming completion without verification
- Never add unrequested features

## Implementation Standards

**Use Bun instead of Node.js for all scripts.**

### Bun Scripts

All Bun scripts MUST follow:
- Flag-based parameters (no positional args)
- Error messages to stderr
- JSON output for structured data
- Exit codes: 0 (success), 1 (error)
- JSDoc type annotations for clarity

```javascript
#!/usr/bin/env bun

const args = process.argv.slice(2);
const params = {};
for (let i = 0; i < args.length; i += 2) {
    const key = args[i].replace(/^--/, '');
    params[key] = args[i + 1];
}

if (!params.param) {
    console.error('Error: --param required');
    process.exit(1);
}
```

### JSON Manipulation

- Use native JSON.parse/JSON.stringify for all JSON operations
- Validate JSON before writing to files
- Handle empty/missing files gracefully

### Script Modification Protocol

When modifying scripts, MUST check all calling components:
- Agents (agents/*/AGENT.md)
- Skills (skills/*.md)
- Commands (commands/*.md)

```bash
# Find files referencing a script
grep -r "script-name.js" agents/ skills/ commands/
```

## Autonomy Boundaries

### You Decide
- Which tools/agents to use
- How to explore codebases
- Implementation approach within constraints
- When to parallelize vs serialize

### User Specifies (when needed)
- Architecture constraints
- Security boundaries
- Style requirements for this project
- Files/areas off-limits

## Self-Correction Signals

Stop and reassess if:
- Loops/retries increasing without progress
- Adding unrequested features
- Temptation to disable/delete tests
- Same error appearing 3+ times

**"Going in circles" = stop, explain blocker, ask for guidance.**

## Defensive Programming

### Multi-Layer Validation Pattern

To prevent bugs from recurring, apply validation at multiple layers:

**Layer 1: Documentation**
- Document rules in AGENT.md, CLAUDE.md, or code comments
- Makes intent clear to developers and AI agents
- Example: "Task status must be: open | in_progress | resolved"

**Layer 2: Code Validation**
- Implement validation in scripts/functions
- Reject invalid values with clear error messages
- Example:
  ```javascript
  const VALID_STATUSES = ['open', 'in_progress', 'resolved'];
  if (!VALID_STATUSES.includes(status)) {
    console.error(`Error: Invalid status '${status}'. Must be: ${VALID_STATUSES.join(' | ')}`);
    process.exit(1);
  }
  ```

**Layer 3: Version Tracking**
- Track changes through version control
- Document breaking changes in commits
- Makes debugging and rollback possible

**Why all three layers?**
- Documentation alone: Can be ignored or missed
- Code validation alone: Intent may be unclear
- Version tracking alone: Doesn't prevent bugs

**When to apply**:
- Enum-like values (status, type, role)
- File format requirements
- State machine transitions
- API contracts
